<!-- build time:Mon Jul 22 2019 00:42:20 GMT+0800 (CST) --><!DOCTYPE html><html class="theme-next muse use-motion" lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0"><link rel="stylesheet" href="/css/main.css?v=7.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/icon2.jpg?v=7.2.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/icon.jpg?v=7.2.0"><link rel="icon" type="image/png" sizes="16x16" href="/images/icon.jpg?v=7.2.0"><link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Muse",version:"7.2.0",sidebar:{position:"left",display:"always",offset:12,onmobile:!1},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},copycode:{enable:!0,show_result:!0,style:"mac"},fancybox:!1,fastclick:!1,lazyload:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},translation:{copy_button:"复制",copy_success:"复制成功",copy_failure:"复制失败"}}</script><meta name="description" content="一、总体概述一是分布式定时器的实现需要解决几个问题，一是如何保证任务被触发，而且只能是一台机器去触发，不能不触发或者多台机器的触发，这些都是不可取的。二是触发过程的通知，通知的机制选择也是一个很讨厌的过程，一般会考虑以下几个因素：及时性容错处理（对应重试的策略）负载均衡并发处理（防止并发的问题）推送重试策略推送相应的参数推送唯一性约束推送消息产生时间是否需要反馈执行的状态是否引入执行状态的检查（主"><meta name="keywords" content="调度中心"><meta property="og:type" content="article"><meta property="og:title" content="分布式定时器的设计"><meta property="og:url" content="http://cordate.github.io/系统设计/分布式定时器的设计.html"><meta property="og:site_name" content="柳絮纷飞"><meta property="og:description" content="一、总体概述一是分布式定时器的实现需要解决几个问题，一是如何保证任务被触发，而且只能是一台机器去触发，不能不触发或者多台机器的触发，这些都是不可取的。二是触发过程的通知，通知的机制选择也是一个很讨厌的过程，一般会考虑以下几个因素：及时性容错处理（对应重试的策略）负载均衡并发处理（防止并发的问题）推送重试策略推送相应的参数推送唯一性约束推送消息产生时间是否需要反馈执行的状态是否引入执行状态的检查（主"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2019-07-21T14:41:23.038Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="分布式定时器的设计"><meta name="twitter:description" content="一、总体概述一是分布式定时器的实现需要解决几个问题，一是如何保证任务被触发，而且只能是一台机器去触发，不能不触发或者多台机器的触发，这些都是不可取的。二是触发过程的通知，通知的机制选择也是一个很讨厌的过程，一般会考虑以下几个因素：及时性容错处理（对应重试的策略）负载均衡并发处理（防止并发的问题）推送重试策略推送相应的参数推送唯一性约束推送消息产生时间是否需要反馈执行的状态是否引入执行状态的检查（主"><link rel="alternate" href="https://legacy.gitbook.com/@gavinzhang1" title="柳絮纷飞" type="application/atom+xml"><link rel="canonical" href="http://cordate.github.io/系统设计/分布式定时器的设计"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>分布式定时器的设计 | 柳絮纷飞</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"></div><div class="site-nav-toggle"><button aria-label="切换导航栏"><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav navbar navbar-default sticky animated fadeInDown" role="navigation"><ul id="menu" class="menu nav navbar-nav hidden-sm"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i>归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="menu-item-icon fa fa-fw fa-calendar"></i>日程表</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="menu-item-icon fa fa-fw fa-sitemap"></i>站点地图</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="menu-item-icon fa fa-fw fa-heartbeat"></i>公益 404</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i> 搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><div class="reading-progress-bar"></div><img src="/images/blog/架构图.jpg" alt="背景图" width="100%"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://cordate.github.io/系统设计/分布式定时器的设计.html"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Author"><meta itemprop="description" content="一个孤独的开发者，正在互联网公司踩坑<br />邮箱：zlcgavin@gmail.com"><meta itemprop="image" content="/images/user-avatar.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="柳絮纷飞"></span><header class="post-header"><h2 class="post-title" itemprop="name headline">分布式定时器的设计</h2><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2018-03-14 15:34:50" itemprop="dateCreated datePublished" datetime="2018-03-14T15:34:50+08:00">2018-03-14</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-07-21 22:41:23" itemprop="dateModified" datetime="2019-07-21T22:41:23+08:00">2019-07-21</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/系统设计/" itemprop="url" rel="index"><span itemprop="name">系统设计</span></a></span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-eye"></i> 阅读次数： <span class="busuanzi-value" id="busuanzi_value_page_pv"></span></span></span><br><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">本文字数：</span> <span title="本文字数">4.3k</span> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">4 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h3 id="一、总体概述"><a href="#一、总体概述" class="headerlink" title="一、总体概述"></a>一、总体概述</h3><p>一是分布式定时器的实现需要解决几个问题，一是如何保证任务被触发，而且只能是一台机器去触发，不能不触发或者多台机器的触发，这些都是不可取的。</p><p>二是触发过程的通知，通知的机制选择也是一个很讨厌的过程，一般会考虑以下几个因素：</p><ul><li>及时性</li><li>容错处理（对应重试的策略）</li><li>负载均衡</li><li>并发处理（防止并发的问题）</li><li>推送重试策略</li><li>推送相应的参数</li><li>推送唯一性约束</li><li>推送消息产生时间</li><li>是否需要反馈执行的状态</li><li>是否引入执行状态的检查（主动查询）</li><li>消息堆积的问题</li><li>消息两次间隔时间短，或者重试策略导致的两个连续的消息一起触发的问题（消息产生时如何去重的问题）</li></ul><p>选择不同的推送方式，可能具有以上不同的特性支持，有的推送方式太过于依赖第三方的支持，而第三方可能只有上面的部分特性不能保证所有特性的支持。还是就是第三方的东西我们一般不好改动，必须寻找其他策略进行解决，所以一般不是很推荐第三方的推送机制。</p><p>三是客户系统定时任务的设计，主要涉及以下几个方面。</p><ul><li>幂等性（同样的消息可能多次接收）</li><li>参数化设计（接口的设计最好设计出一些定制参数，同时需要检查参数的正确性）</li><li>如何通知执行状态，这里可能对消息的及时性要求不高，我们可以使用一些消息中间件。</li></ul><h3 id="定时任务分配"><a href="#定时任务分配" class="headerlink" title="定时任务分配"></a>定时任务分配</h3><p>主要需要思考消息去重的问题。</p><h4 id="加锁机制"><a href="#加锁机制" class="headerlink" title="加锁机制"></a>加锁机制</h4><p>这种加锁机制是可以解决我们的问题，而且我们也不需要将任务进行分散到多台机器去执行，所以采用多台机器的加锁机制确实可以解决我们的问题，但是我们不得不考虑以下几个问题：</p><ul><li>多台机器时间不同步的问题，会导致每台机器触发的时间是不一样的，所以必须有同步一下的机制，要么同步时间，要么有消息通知过来，大家一起行动。最好的做法就是锁上加时间，只要我们知道下一次触发是什么时候，我们就可以不放锁，让时间来帮我们放锁，但是还是会有一点小时间差的错误，但是基本上能解决我们的问题。</li><li>因为各种原因，锁抢占可能并不是那么公平，总会有人先获得锁，而且它获得锁的概率很大。</li><li>如果是配置成interval的方式启动定时器，那么会出现每台定时器启动的时机不同导致，原本5分钟执行一次的任务，变成了2，3，2，3这样的时间序列进行，这对我们来说绝不是什么好现象。</li></ul><p>这个最后我们选用的是这种方式实现的，但是我们使用的事quartz集群的方式进行的实现。这个需要看一下quartz集群内部的实现方式了，这里就不提了，后面我们再说吧！但我想一定是通过数据库进行了同步操作，毕竟quartz的源码需要研究一下，还有就是他们建立了10张左右的数据表来进行同步，所以这个需要深入研究的。</p><h4 id="任务分片的方式进行"><a href="#任务分片的方式进行" class="headerlink" title="任务分片的方式进行"></a>任务分片的方式进行</h4><p>任务分片的方式是不进行相应的处理的，基本上是集群中有一台主节点，这台leader进行任务的分配。所以它必须知道集群中有几台机器可达，然后将任务发送到每一台机器，每台机器处理哪些任务等等，这样的话我们就可以实现相应的处理机制。</p><p>这里面有两个点，一是leader的选取和重新选取策略，二是如何知道有几台机器存活。其实就是利用Zookeeper或者其他的同步组件就能实现这些功能。</p><p>如果leader挂了，我们可以使用zk的leader选举机制找到新的leader由它进行新任务的重新分配，如果leader发现有新加入的机器，也要进行任务的重新分配，如果发现有机器减少也需要进行任务的重新分配。机器的在活量，Zookeeper是可以提供给我们的。</p><p>这种方式可以解决我们的问题，其实也可以通过每次竞争，每次都获取分片分配任务，就是每次要做任务的时候，每个人都踊跃当组长，但是权利就是这一次，下次要重新抢组长的位置。再由组长取得任务并进行任务的分配，这种方式就是每次都要重新分配任务，上面的那种方式，除非有改动leader才会重新进行任务的分配。</p><h4 id="消息去重"><a href="#消息去重" class="headerlink" title="消息去重"></a>消息去重</h4><p>两次相同任务的触发因为某些原因一起发送的问题，这个消息如何进行去重，也是一个非常值得研究的问题。</p><p>主要还是看上一个消息的投递状态，这样我们可以记录任务的最后一个消息的id，然后本次触发可能需要记录上次触发的id，并进行相应的判断处理，执行去重策略。</p><h3 id="推送方式"><a href="#推送方式" class="headerlink" title="推送方式"></a>推送方式</h3><h4 id="http方式推送"><a href="#http方式推送" class="headerlink" title="http方式推送"></a>http方式推送</h4><p>这种推送方式需要考虑推送的状态和最终的推送结果。中间需要考虑重试机制；重试机制有一个问题就是重试花了很长时间，导致下次触发事件发生了需要连续推两次，这样就有一个问题是两次都要推还是只推送一次，还是就是如何防止消息的堆积。</p><p>另外重试几次大概要花多少时间，这个是无法估计的，因为这里包括超时的时间，这个时间是不固定的。如果不希望两次推送一起，就需要实现出重的策略。如果任务不紧急可以实现只推送一次或者几次，失败后就等待下一次的触发。这个可以在加定时任务的时候作为一个配置参数。总之这个东西是需要统筹考虑的。</p><p>总之重试策略不是无限循环的，需要最终的失败情况，如果失败，用户可以选择重新推送。这个后面会讲到。</p><h4 id="订阅发布模式"><a href="#订阅发布模式" class="headerlink" title="订阅发布模式"></a>订阅发布模式</h4><p>在一定程度上缓解了http推送的问题。这里注意你使用的那种订阅发布模式的实现可能存在未知的问题，比如下面的说明：<span class="exturl" data-url="aHR0cDovL2Jsb2cuY3Nkbi5uZXQvdTAxMTQ5OTc0Ny9hcnRpY2xlL2RldGFpbHMvNTEyMzI5ODE=" title="http://blog.csdn.net/u011499747/article/details/51232981">redis之发布与订阅(publish/subscribe模式)<i class="fa fa-external-link"></i></span>. 另外还要注意订阅的模式，负载均衡，及时性、消息堆积、消息去重、推送可靠性（是否保证送达）、消费者重连是否会重推等功能。</p><p>以上的这些问题，如果是在http中我们是可以自己定制的，但是在这边很多我们无从改变，我们解决问题也只能采用巧妙的方式进行处理。</p><h4 id="MQ消息队列"><a href="#MQ消息队列" class="headerlink" title="MQ消息队列"></a>MQ消息队列</h4><p>其实MQ的方式也有很多的问题，首先就是消息的堆积处理，因为我们无从判断上一个消息是否被消费，如果没有被消费我们才有下一步的措施，也可以使用回调，判断上一个任务是否被消费，如果被消费才进行，这样一来一回的延时还是挺高的。</p><p>还有MQ是否实现相应的负载均衡策略，每个系统的订阅模式是否支持，是否应该为每个系统定制单独的tag，我觉得这个是必然的。否则这个定时器只是为了单个系统使用的。注意消费的模式一定是点到点的方式。另外就是注意MQ要能实现多Consumer的模式。还是可能还是具体到MQ是如何实现负载均衡的。</p><p>如果有两个相同的消息推过来MQ会作何处理也是一个待解决的问题，因为RocketMQ中是通过多Broker的方式实现的，也就是说一个Broker处理多个队列，一个消息放到一个队列时是顺序发送的，但是同样的消息存到了不同的队列中，那可能存在并发发送的可能性。这样的话，对系统是不利的。</p><p>消费者可能多次接受到推送的消息，所以必须保证消费者的幂等性问题。这也是MQ所不能解决的问题。必须保证幂等性。</p><p>可能还有很多其他需要考虑的问题，这里就写这么多吧，以后想到了，可以再进行相应的补充说明。</p><h4 id="Socket方式"><a href="#Socket方式" class="headerlink" title="Socket方式"></a>Socket方式</h4><p>这种方式和http方式比较类似，但是偏底层，这样的设计可能会影响系统的设计。因为需要自己进行socket编程或者使用netty进行连接。考虑到的问题和http方式是类似的。</p><p>另外Socket可以进行长连接，但是短线了可能需要相应的重连机制。还有就是谁作为Client，谁作为Server这也是必须要解决的问题；可以使服务做为Server，定时器作为Client。</p><p>其实两种方式还是有不少的区别的。</p><h3 id="客户端的设计"><a href="#客户端的设计" class="headerlink" title="客户端的设计"></a>客户端的设计</h3><p>因为是分布式的，所以不能保证推送只推一次，即使是MQ也不能保证，所以我们必须考虑幂等性的设计，还有就是参数化设计和执行反馈。</p><h4 id="幂等性"><a href="#幂等性" class="headerlink" title="幂等性"></a>幂等性</h4><p>幂等性的设计主要关注，如何实现。一个就是统一的id设置，这种方式可能导致每次都要查询数据库的问题，当然你可以设计为保证几天内的数据是幂等性的。我觉得可以使用拦截器统一过滤，但是这不是绝对的，有的调度消息可能就是不需要幂等性的。</p><p>还有一些可能根据时间来设置，比如说当天是否执行过，如执行过就不执行了。</p><p>还有可能就是设置序列号，记录当前执行过的序列id，发来的序列号小于等于执行过的最大序列号，那么就不执行，否则就进行执行，这样的话客户端需要实现相应的代码，但是这种方式比较靠谱。这个id，我想可以通过时间来实现。这样的话是比较解耦的。因为时间是自然序列，所以用它处理id问题最合适不过的，如果有其他自然序列当然最好了。这符合解决问题的最好方式就是恰好不解决它的思路。</p><p>总之实现幂等性的方式应该还有很多，总能找到很好的解决思路。</p><h4 id="参数化设计"><a href="#参数化设计" class="headerlink" title="参数化设计"></a>参数化设计</h4><p>有的时候定时调用会失败，所以我们不得不进行重试策略，但是重试策略有一个问题，就是时间时效性，或者说客户端这时候接受到消息压根就不知这是历史数据，可能所做的处理和之前推过来是有差异的。</p><p>那么就需要就定时任务接口进行参数化的设计，比如统一当天的数据，不要从系统时间获取，而是可以通过时间参数传过来，统计传过来那天的数据。这样我们点击重试的时候就能够解决我们要重试的可能是那天的数据。这个其实就是本来在你系统获取的数据放到定时器系统中去获取，然后推送过来，这样我们可以进行重试策略。但其实这样就比较依赖定时系统，但一般定时系统的时间是正确的，所以一般不会出问题，这是客户端需要判别消息产生的时间和需要统计的时间是不是同一天的数据，如果不是的话，就判别有错，如果是相差一天的，就判断是否是相差一天的数据。其实这样做也是没有必要的。</p><p>但是有的时候参数数据可能并不是系统提供的，由程序根据相应的状况进行提供，那这样其实就不好办了，我们需要判别这种定时器是否需要考虑隔天重试带来的影响，有的可能是周期任务，当前任务失败，完全可以等待下次任务来处理，所以不需要进行重试的。有的可能需要，而且需要进行相应地重试，但是这种策略可能需要具体业务场景才可能明白解决问题的思路是什么。总之参数化的设计是必然的，这样可以解决很多分布式定时器的问题。</p><p>但是为了方便我觉得，任务的序列号需要传送，任务的产生时间需要传送，如果需要传送任务的数据库id的话，也可以进行传送。这些信息可以让客户端有相应的策略来解决自己定制化的需求问题。</p><p>有关参数化的设计就提到这里，如果有新的想法，我会进行相应的更新。</p><h4 id="执行反馈"><a href="#执行反馈" class="headerlink" title="执行反馈"></a>执行反馈</h4><p>客户端执行完成后，可以回调定时器中心，指明id或者code，让定时器中心去处理。这样的话，定时器中心某个任务下次触发时可以判断上一个任务状态，根据上一个任务的状态判断，当前这个任务是去触发，还是去丢弃。</p><p>我们也可以通过执行状态判断一下，是否有问题，但是其实我们还是有一些信息需要处理。</p><p>这个反馈的问题是，需要客户端的重试策略，盲目利用这个信息做触发判断可能有问题。其实更多的时候大家并不care这个反馈的时效和最终结果是否通知过来，所以这个可能并不是一个很好的做法，而只是为了看看而已。</p><h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在分布式系统中其实去重策略的确是一个比较烦人的事情，里面涉及的点其实比较多，我们要解决的问题其实也很多，大家在解决这些问题的时候，需要留心，可能一不小心，你的系统可能就进入了一个不太好解决的泥坑之中。</p></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>Gavin Zhang</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="http://cordate.github.io/系统设计/分布式定时器的设计.html" title="分布式定时器的设计">http://cordate.github.io/系统设计/分布式定时器的设计.html</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/调度中心/" rel="tag"><i class="fa fa-tag"></i> 调度中心</a></div><div class="post-widgets"><div class="social_share"><div><script src="//cdn.jsdelivr.net/npm/ilyabirman-likely@2/release/likely.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/ilyabirman-likely@2/release/likely.css"><div class="likely"><div class="twitter">Tweet</div><div class="facebook">Share</div><div class="linkedin">Link</div><div class="gplus">Plus</div><div class="vkontakte">Share</div><div class="odnoklassniki">Class</div><div class="telegram">Send</div><div class="whatsapp">Send</div><div class="pinterest">Pin</div></div></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/系统设计/高可用用户中心设计.html" rel="next" title="高可用用户中心设计"><i class="fa fa-chevron-left"></i> 高可用用户中心设计</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/系统设计/通用日志表的设计.html" rel="prev" title="通用日志表的设计">通用日志表的设计 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="gitalk-container"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/user-avatar.jpg" alt="Gavin Zhang"><p class="site-author-name" itemprop="name">Gavin Zhang</p><div class="site-description motion-element" itemprop="description">一个孤独的开发者，正在互联网公司踩坑<br>邮箱：zlcgavin@gmail.com</div></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">111</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">25</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">102</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="feed-link motion-element"><a href="https://legacy.gitbook.com/@gavinzhang1" rel="alternate"><i class="fa fa-rss"></i>RSS</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lvdXJuYW1l" title="GitHub &rarr; https://github.com/yourname"><i class="fa fa-fw fa-github"></i>GitHub</span></span></div><div class="cc-license motion-element" itemprop="license"><span class="exturl cc-opacity" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#一、总体概述"><span class="nav-number">1.</span> <span class="nav-text">一、总体概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定时任务分配"><span class="nav-number">2.</span> <span class="nav-text">定时任务分配</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#加锁机制"><span class="nav-number">2.1.</span> <span class="nav-text">加锁机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#任务分片的方式进行"><span class="nav-number">2.2.</span> <span class="nav-text">任务分片的方式进行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息去重"><span class="nav-number">2.3.</span> <span class="nav-text">消息去重</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#推送方式"><span class="nav-number">3.</span> <span class="nav-text">推送方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#http方式推送"><span class="nav-number">3.1.</span> <span class="nav-text">http方式推送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#订阅发布模式"><span class="nav-number">3.2.</span> <span class="nav-text">订阅发布模式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#MQ消息队列"><span class="nav-number">3.3.</span> <span class="nav-text">MQ消息队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Socket方式"><span class="nav-number">3.4.</span> <span class="nav-text">Socket方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端的设计"><span class="nav-number">4.</span> <span class="nav-text">客户端的设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#幂等性"><span class="nav-number">4.1.</span> <span class="nav-text">幂等性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参数化设计"><span class="nav-number">4.2.</span> <span class="nav-text">参数化设计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行反馈"><span class="nav-number">4.3.</span> <span class="nav-text">执行反馈</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li></ol></div></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019-07-22</span> <span class="with-love" id="animate"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Gavin Zhang</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">站点总字数：</span> <span title="站点总字数">809k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span class="post-meta-item-text">站点阅读时长 &asymp;</span> <span title="站点阅读时长">12:15</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item-icon"><i class="fa fa-user"></i> </span><span class="site-uv" title="总访客量"><span class="busuanzi-value" id="busuanzi_value_site_uv"></span> </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-eye"></i> </span><span class="site-pv" title="总访问量"><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5d2f5e89bbcb7cce" async></script></div></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script><script src="/lib/jquery/index.js?v=3.4.1"></script><script src="/lib/lazyload/lozad.min.js?v=1.10.0"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/lib/reading_progress/reading_progress.js"></script><script src="/js/utils.js?v=7.2.0"></script><script src="/js/motion.js?v=7.2.0"></script><script src="/js/schemes/muse.js?v=7.2.0"></script><script src="/js/scrollspy.js?v=7.2.0"></script><script src="/js/post-details.js?v=7.2.0"></script><script src="/js/next-boot.js?v=7.2.0"></script><script src="/js/js.cookie.js?v=7.2.0"></script><script src="/js/scroll-cookie.js?v=7.2.0"></script><script src="/js/exturl.js?v=7.2.0"></script><script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"><script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script><script>var gitalk=new Gitalk({clientID:"9ed54522a8818f2ebf63",clientSecret:"2977df7ea417b2b266949482dce578d39d7a2df6",repo:"cordate.github.io",owner:"cordate",admin:["cordate"],id:md5(location.pathname),language:"zh-CN",distractionFreeMode:"true"});gitalk.render("gitalk-container")</script><script>function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var e=$("#local-search-input");e.attr("autocapitalize","none"),e.attr("autocorrect","off"),e.focus()}var isfetched=!1,isXml=!0,search_path="search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(e){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(e,t,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:e,dataType:isXml?"xml":"json",async:!0,success:function(e){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",e).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():e,r=document.getElementById(t),s=document.getElementById(o),a=function(){var e=r.value.trim().toLowerCase(),t=e.split(/[\s\-]+/);t.length>1&&t.push(e);var o=[];if(e.length>0&&n.forEach(function(n){function r(t,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===e&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(e,t){var o="",n=t.start;return t.hits.forEach(function(t){o+=e.substring(n,t.position);var r=t.position+t.length;o+='<b class="search-keyword">'+e.substring(t.position,r)+"</b>",n=r}),o+=e.substring(n,t.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url).replace(/\/{2,}/g,"/"),d=[],g=[];if(""!=l&&(t.forEach(function(e){function t(e,t,o){var n=e.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(t=t.toLowerCase(),e=e.toLowerCase());(s=t.indexOf(e,r))>-1;)a.push({position:s,word:e}),r=s+n;return a}d=d.concat(t(e,h,!1)),g=g.concat(t(e,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(e){e.sort(function(e,t){return t.position!==e.position?t.position-e.position:e.word.length-t.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hits.length!==t.hits.length?t.hits.length-e.hits.length:e.start-t.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(e){b+="<a href='"+f+'\'><p class="search-result">'+s(p,e)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===t.length&&""===t[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x"></i></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>';else{o.sort(function(e,t){return e.searchTextCount!==t.searchTextCount?t.searchTextCount-e.searchTextCount:e.hitCount!==t.hitCount?t.hitCount-e.hitCount:t.id-e.id});var a='<ul class="search-result-list">';o.forEach(function(e){a+=e.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(e){e.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(e){e.stopPropagation()}),$(document).on("keyup",function(e){var t=27===e.which&&$(".search-popup").is(":visible");t&&onPopupClose()})</script><script>$("body").find("pre.mermaid").length&&$.ajax({type:"GET",url:"//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js",dataType:"script",cache:!0,success:function(){mermaid.initialize({theme:"forest",logLevel:3,flowchart:{curve:"linear"},gantt:{axisFormat:"%m/%d/%Y"},sequence:{actorMargin:50}})}})</script><script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({log:!1,pluginJsPath:"lib/",pluginModelPath:"assets/",pluginRootPath:"live2dw/",tagMode:!1})</script></body></html><!-- rebuild by neat -->