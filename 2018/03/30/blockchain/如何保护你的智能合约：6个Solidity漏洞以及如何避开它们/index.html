<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.4">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.4" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.0.4',
    sidebar: {"position":"left","display":"always","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="solidity," />


<meta name="description" content="智能合约是“不可变的”。一旦部署，它们的代码是不能更改的，导致无法修复任何发现的bug。 在潜在的未来里，整个组织都由智能合约代码管控，对于适当的安全性需求巨大。过去的黑客如TheDAO或去年的Parity黑客（7月、11月）提高了开发者们的警惕，可我们还有很长的路要走。 范围溢出的问题 代币中记录用户的代币数量，一旦上溢，就会出现用户代币数归零的现象。 同样，减号会出现下溢的问题。 如果溢出出现">
<meta name="keywords" content="solidity">
<meta property="og:type" content="article">
<meta property="og:title" content="如何保护你的智能合约：6个Solidity漏洞以及如何避开它们">
<meta property="og:url" content="http://cordate.github.io/2018/03/30/blockchain/如何保护你的智能合约：6个Solidity漏洞以及如何避开它们/index.html">
<meta property="og:site_name" content="柳絮纷飞">
<meta property="og:description" content="智能合约是“不可变的”。一旦部署，它们的代码是不能更改的，导致无法修复任何发现的bug。 在潜在的未来里，整个组织都由智能合约代码管控，对于适当的安全性需求巨大。过去的黑客如TheDAO或去年的Parity黑客（7月、11月）提高了开发者们的警惕，可我们还有很长的路要走。 范围溢出的问题 代币中记录用户的代币数量，一旦上溢，就会出现用户代币数归零的现象。 同样，减号会出现下溢的问题。 如果溢出出现">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-03-30T07:55:39.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="如何保护你的智能合约：6个Solidity漏洞以及如何避开它们">
<meta name="twitter:description" content="智能合约是“不可变的”。一旦部署，它们的代码是不能更改的，导致无法修复任何发现的bug。 在潜在的未来里，整个组织都由智能合约代码管控，对于适当的安全性需求巨大。过去的黑客如TheDAO或去年的Parity黑客（7月、11月）提高了开发者们的警惕，可我们还有很长的路要走。 范围溢出的问题 代币中记录用户的代币数量，一旦上溢，就会出现用户代币数归零的现象。 同样，减号会出现下溢的问题。 如果溢出出现">






  <link rel="canonical" href="http://cordate.github.io/2018/03/30/blockchain/如何保护你的智能合约：6个Solidity漏洞以及如何避开它们/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>如何保护你的智能合约：6个Solidity漏洞以及如何避开它们 | 柳絮纷飞</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">柳絮纷飞</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Gavin的个人博客</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://cordate.github.io/2018/03/30/blockchain/如何保护你的智能合约：6个Solidity漏洞以及如何避开它们/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gavin Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/user-avatar">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="柳絮纷飞">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">如何保护你的智能合约：6个Solidity漏洞以及如何避开它们</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-30T11:23:37+08:00">2018-03-30</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/区块链/" itemprop="url" rel="index"><span itemprop="name">区块链</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/区块链/ethereum/" itemprop="url" rel="index"><span itemprop="name">ethereum</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>智能合约是“不可变的”。一旦部署，它们的代码是不能更改的，导致无法修复任何发现的bug。</p>
<p>在潜在的未来里，整个组织都由智能合约代码管控，对于适当的安全性需求巨大。过去的黑客如TheDAO或去年的Parity黑客（7月、11月）提高了开发者们的警惕，可我们还有很长的路要走。</p>
<h2 id="范围溢出的问题"><a href="#范围溢出的问题" class="headerlink" title="范围溢出的问题"></a>范围溢出的问题</h2><ol>
<li>代币中记录用户的代币数量，一旦上溢，就会出现用户代币数归零的现象。</li>
<li>同样，减号会出现下溢的问题。</li>
<li>如果溢出出现在循环语句中，那么可能就会出现不进入循环、过早结束循环和无限循环的问题。</li>
</ol>
<p>缓解措施：现在使用OpenZeppelin的<a href="https://github.com/OpenZeppelin/zeppelin-solidity/blob/master/contracts/math/SafeMath.sol" target="_blank" rel="noopener">SafeMath</a>库已经成为了一个标准。</p>
<h2 id="可视性-Visibility-和Delegatecall"><a href="#可视性-Visibility-和Delegatecall" class="headerlink" title="可视性(Visibility)和Delegatecall"></a>可视性(Visibility)和Delegatecall</h2><p>对去年7月发生的事有印象的人来说，这个bug就很眼熟，毕竟Parity钱包被黑导致用户损失了3千万美金。</p>
<p><b style="color:red">Solidity的可视性修改功能和它们的区别:</b></p>
<ul>
<li>公共(Public)函数可以被任何人调用（被合约里的函数、继承合约里的函数、或者外面的用户）。</li>
<li>外部(External)函数只能从外部访问，<b style="color:blue">意味着它们不能被合约里的其他函数调用</b>。下面的要点不能编译，cannotBeCalled的外部可视性不允许它被合约里的函数调用（但它可以被别的合约调用）。</li>
</ul>
<p><b style="color:red">外部函数用起来更便宜因为它使用calldata操作码，而公共函数需要把所有参数复制到内存中</b>，详情请看<a href="https://ethereum.stackexchange.com/questions/19380/external-vs-public-best-practices?answertab=active#tab-top" target="_blank" rel="noopener">这里</a>。</p>
<p><b style="color:blue">私有(Private)和内部(Internal)函数更简单：private是只能在该合约里使用，而internal提供了一个更宽松的限制，它允许从母合约处继承的子合约使用那个函数。那就是说，除了需要外部交互的时候，设置你的函数为private或者internal。</b></p>
<h3 id="Delegatecall"><a href="#Delegatecall" class="headerlink" title="Delegatecall"></a>Delegatecall</h3><p>引述<a href="http://solidity.readthedocs.io/en/develop/introduction-to-smart-contracts.html?highlight=delegatecall#delegatecall-callcode-and-libraries" target="_blank" rel="noopener">solidity文件</a>：</p>
<p><quota>“Delegatecall和信息调用，除了目标地址的代码要在请求调用的合约的上下文中执行之外，是完全一样的。msg.sender和msg.value不改变他们的值。 这意味着合约可以在运行是动态加载来自不同地址的代码。存储、当前地址和余额仍都取决于请求调用的合约，只有代码来自被调用合约。”</quota><b style="color:red">意思就是说将别的合约加入到自己的代码空间执行，但是不会改变别人合约的状态。</b></p>
<p><b style="color:red">这个低级函数非常有用，因为它是实现库和模块化代码的中坚力量。 然而，它打开了漏洞的大门，因为你的合同基本上允许任何人以他们的状态做任何他们想做的。</b></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.11;</span><br><span class="line"></span><br><span class="line">// Credits to OpenZeppelin for this contract taken from the Ethernaut CTF</span><br><span class="line">// https://ethernaut.zeppelin.solutions/level/0x68756ad5e1039e4f3b895cfaa16a3a79a5a73c59</span><br><span class="line">contract Delegate &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  function Delegate(address _owner) &#123;</span><br><span class="line">    owner = _owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  function pwn() &#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line">  Delegate delegate;</span><br><span class="line"></span><br><span class="line">  function Delegation(address _delegateAddress) &#123;</span><br><span class="line">    delegate = Delegate(_delegateAddress);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  // an attacker can call Delegate.pwn() in the context of Delegation</span><br><span class="line">  // this means that pwn() will modify the state of **Delegation** and not Delegate</span><br><span class="line">  // the result is that the attacker takes unauthorized ownership of the contract</span><br><span class="line">  function() &#123;</span><br><span class="line">    if(delegate.delegatecall(msg.data)) &#123;</span><br><span class="line">      this;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Parity黑客涉及两个不安全的可见性修改功能组合，以及用任意数据滥用delegate调用。易受攻击的合约的函数实现了delegatecall，并且一个来自其他合约，能修改主权的函数被设成公共的。这使得攻击者可以设计msg.data字段来调用易受攻击的函数。</p>
<p>至于msg.data字段里会包含什么，那会是你想要调用函数的签名。这里的签名指的是函数原型的sha3（keccak256的别名）散列的前8个字节。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// In this case:</span><br><span class="line">web3.sha3(&quot;pwn()&quot;).slice(0,10) --&gt; 0xdd365b8b</span><br><span class="line">// If the function takes an argument, pwn(uint256 x):</span><br><span class="line">web3.sha3(&quot;pwn(uint256)&quot;).slice(0,10) --&gt; 0x35f4581b</span><br></pre></td></tr></table></figure></p>
<h2 id="可重入性（The-DAO黑客事件）"><a href="#可重入性（The-DAO黑客事件）" class="headerlink" title="可重入性（The DAO黑客事件）"></a>可重入性（The DAO黑客事件）</h2><p>Solidity的call函数当被带着value调用时，会发送所有它收到的gas。在下面的代码片段中，调用是在实际减少发件人的余额之前完成的。一个在TheDAO黑客事件发生时reddit上的评论很好地解释了这个漏洞：</p>
<p><b style="color:blue">简单来说，就好像银行出纳员在她把你所要求的钱全部给你之前，不会更改你的余额。“我能取出500美金吗？等一下，在那之前，我能取出500美金吗？” 等等等等。按照设计的智能合约只会在最开始检查你有500美金，一次，而且允许它们自己被打断。</b></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function withdraw(uint _amount) public &#123;</span><br><span class="line">  if(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">    if(msg.sender.call.value(_amount)()) &#123;</span><br><span class="line">      _amount;</span><br><span class="line">    &#125;</span><br><span class="line">    balances[msg.sender] -= _amount;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>正如这里所详细描述的，修复方案就是先减少发送人的余额再进行价值转移。对于使用并行编程的人来说，另外一个解决方法就是用互斥锁，从而一起缓解各种竞争条件。</p>
<p>目前来说，使用require(msg.sender.transfer(_value))是处理这些情况的最好的方法。</p>
<p>详细的信息也可以查看<a href="http://vessenes.com/more-ethereum-attacks-race-to-empty-is-the-real-deal/" target="_blank" rel="noopener">More Ethereum Attacks: Race-To-Empty is the Real Deal</a></p>
<p>也可以查看：<a href="http://www.bikeji.com/discussions/4027" target="_blank" rel="noopener">DAO攻击简单解释</a></p>
<h2 id="强行将以太币置入合约"><a href="#强行将以太币置入合约" class="headerlink" title="强行将以太币置入合约"></a>强行将以太币置入合约</h2><p>Solidity的selfdestruct做两件事。(其实就是指删除合约地址)</p>
<ol>
<li>它使合约变为不可用，有效地删除该地址的bytecode。</li>
<li>它把合约的所有资金发送到目标地址。</li>
</ol>
<p>这里的一个特殊情况是，如果接收地址是一个合约，那么它的<a href="https://solidity.readthedocs.io/en/develop/security-considerations.html#sending-and-receiving-ether" target="_blank" rel="noopener">fallback函数不会被执行</a>。</p>
<p>这意味着，如果一个合约的函数有一个依赖于该合约的余额低于一定数额的条件语句，那个语句可能会被绕过:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity 0.4.18;</span><br><span class="line"></span><br><span class="line">contract ForceEther &#123;</span><br><span class="line"></span><br><span class="line">  bool youWin = false;</span><br><span class="line"></span><br><span class="line">  function onlyNonZeroBalance() &#123;</span><br><span class="line">      require(this.balance &gt; 0); </span><br><span class="line">      youWin = true;</span><br><span class="line">  &#125;</span><br><span class="line">  // throw if any ether is received</span><br><span class="line">  function() payable &#123;</span><br><span class="line">    revert();</span><br><span class="line">  &#125;</span><br><span class="line">         </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于那个没有的fallback函数，通常该合约无法收到以太币。<b style="color:red">但是，如果一个合约以这个合约为目标自毁，后退函数则不会被调用</b>。结果this.balance变得大于0，所以攻击者就可以在onlyNonZeroBalance里绕过require语句。</p>
<p><b style="color:red">缓解措施：永远不要用一个合约的余额作守卫。</b></p>
<h2 id="调用未知（DoS意外还原）"><a href="#调用未知（DoS意外还原）" class="headerlink" title="调用未知（DoS意外还原）"></a>调用未知（DoS意外还原）</h2><p>这个漏洞出现了在<a href="https://www.kingoftheether.com/" target="_blank" rel="noopener">King of Ether</a>智能合约中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.18;</span><br><span class="line">contract CallToTheUnknown &#123;</span><br><span class="line">  // Highest bidder becomes the Leader. </span><br><span class="line">  // Vulnerable to DoS attack by an attacker contract which reverts all transactions to it.</span><br><span class="line"></span><br><span class="line">    address currentLeader;</span><br><span class="line">    uint highestBid;</span><br><span class="line"></span><br><span class="line">    function() payable &#123;</span><br><span class="line">        require(msg.value &gt; highestBid);</span><br><span class="line">        require(currentLeader.send(highestBid)); // Refund the old leader, if it fails then revert</span><br><span class="line">        currentLeader = msg.sender;</span><br><span class="line">        highestBid = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Pwn &#123;</span><br><span class="line">  // call become leader </span><br><span class="line">  function becomeLeader(address _address, uint bidAmount) &#123;</span><br><span class="line">    _address.call.value(bidAmount);</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  // reverts anytime it receives ether, thus cancelling out the change of the leader</span><br><span class="line">  function() payable &#123;</span><br><span class="line">    revert();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这种情况下，攻击者的合约可以先通过向不安全的合约发送足够的以太成为主导。然后，另一个试图成为主导的玩家的交易将由于上面片段中的第25行(revert();)被抛出。虽然是一次简单的攻击，但这会导致合约永久性地拒绝服务，导致合约无效。这可以在遵循相同模式的其他庞式骗局合约中找到。</p>
<h2 id="短地址攻击"><a href="#短地址攻击" class="headerlink" title="短地址攻击"></a>短地址攻击</h2><p>这种攻击是由Golem团队发现的，详情请看<a href="https://blog.golemproject.net/how-to-find-10m-by-just-reading-blockchain-6ae9d39fcd95" target="_blank" rel="noopener">这篇文章</a>。这个漏洞允许攻击者滥用transfer函数并取出比他被准许的更多的ERC20代币。</p>
<p>注意：为了简单起见，我们会用正常一半大小的文字。</p>
<p>为了解释这个bug，让我们假设一个钱包里有10000个代币的交易所，和一个在那个交易所钱包里有32个代币余额的用户。让我们再假设这个用户的地址是0x12345600（注意尾部的零）而且他们想要取出比自己余额大的数额。他们就会去交易所，点击代币的取出按钮，<b style="color:blue">然后输入他们的地址但去掉尾部的零（交易所不验证输入的信息然后允许交易通过，即使攻击者的地址长度是无效的）</b>。</p>
<p>接着，EVM通过连接函数的签名和参数来计算输入的数据以便交易被执行。</p>
<p>ERC20的转送函数写为transfer(address to, uint256 amount)。那3个字段如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sig : a9059cbb = web3.sha3(&quot;transfer(address,uint256)&quot;).slice(0,10)</span><br><span class="line">arg1: 123456   = receiving address</span><br><span class="line">arg2: 00000020  = 32 in hexademical (0x20)</span><br><span class="line">----------------------------------------</span><br><span class="line">Concatenated: a9059cbb 123456 00000020</span><br><span class="line">Transaction input data: 0xa9059cbb12345600000020</span><br></pre></td></tr></table></figure></p>
<h3 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h3><p>仔细观察，交易的长度是2个字节（在现实世界中全字4个字节）。<b style="color:red">在这种情况下，EVM将会为交易补上尾部的零</b>， 变成：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">0xa9059cbb1234560000002000</span><br><span class="line">// a9059cbb = web3.sha3(&quot;transfer(address,uint256)&quot;).slice(0,10)</span><br><span class="line">// 12345600   = receiving address</span><br><span class="line">// 00002000  = 8192 in hexademical (0x2000 == 0x20&lt;&lt;8)</span><br></pre></td></tr></table></figure></p>
<p>这样一来，即使攻击者在交易所中的余额是32个代币，他们也能执行一个数额大得多的、合法的转移。这当然是在发送账户（交易所的钱包）拥有足够的转账余额的基础上。</p>
<p><b style="color:red">缓解措施：</b></p>
<ol>
<li>如果msg.data的大小无效，抛出</li>
<li>交易所必须对输入信息进行验证</li>
</ol>
<h2 id="额外红利"><a href="#额外红利" class="headerlink" title="额外红利"></a>额外红利</h2><p>避免在你的商业逻辑中使用now和block.blockhash，因为他们的结果是可预测的，或者会被矿工操控。想了解更多，请看<a href="https://link.zhihu.com/?target=https%3A//www.reddit.com/r/ethereum/comments/483rr1/do_not_use_block_hash_as_source_of_randomness/" target="_blank" rel="noopener">这里</a>。</p>
<h2 id="Q-amp-A"><a href="#Q-amp-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h2><h3 id="我能做些什么来保护我的智能合约呢"><a href="#我能做些什么来保护我的智能合约呢" class="headerlink" title="我能做些什么来保护我的智能合约呢"></a>我能做些什么来保护我的智能合约呢</h3><p>这在很多地方都有提到，我个人最喜欢的在<a href="https://blog.zeppelin.solutions/onward-with-ethereum-smart-contract-security-97a827e47702" target="_blank" rel="noopener">这里</a>。</p>
<p>其中，我最重要的选择是：</p>
<ol>
<li>别写华丽的代码</li>
<li>使用审计和测试过的代码</li>
<li>写尽可能多的单元测试</li>
</ol>
<h3 id="我能用什么工具来审计和分析我的代码呢？"><a href="#我能用什么工具来审计和分析我的代码呢？" class="headerlink" title="我能用什么工具来审计和分析我的代码呢？"></a>我能用什么工具来审计和分析我的代码呢？</h3><p>首先，solc执行语义检查是走向安全性的一大步，因为编译时可能会发现潜在的错误。</p>
<ol>
<li><a href="http://securify.ch/" target="_blank" rel="noopener">Securify.ch</a>是一个为了智能合约的静态分析工具</li>
<li><a href="http://remix.ethereum.org/" target="_blank" rel="noopener">Remix</a>也对你的代码静态分析，并能够发现如未初始化的存储指针和重入的错误</li>
<li><a href="https://github.com/melonproject/oyente" target="_blank" rel="noopener">Oyente</a>是另一个最近发布的智能合约分析工具</li>
<li><a href="https://github.com/IC3Hydra/Hydra" target="_blank" rel="noopener">Hydra</a>是一个“为了加密经济合约安全性的框架，去中心化安全奖励”</li>
<li><a href="https://github.com/comaeio/porosity" target="_blank" rel="noopener">Porosity</a>是一个“基于区块链以太坊智能合约的反编译器”</li>
<li><a href="https://github.com/trailofbits/manticore/" target="_blank" rel="noopener">Manticore</a>是一款带EVM支持的动态二进制分析工具</li>
<li><a href="https://github.com/trailofbits/ethersplay" target="_blank" rel="noopener">Ethersplay</a>是一个EVM的<a href="https://binary.ninja/" target="_blank" rel="noopener">Binary Ninja</a>插件</li>
</ol>
<p>最后，通过使用如solgraph之类的工具来图像化你的代码，可以帮助你发现关于函数可见性的潜在bug。</p>
<p><a href="https://github.com/raineorshine/solgraph" target="_blank" rel="noopener">https://github.com/raineorshine/solgraph</a></p>
<p>要更深入地了解对智能合约的攻击，请参阅：</p>
<ul>
<li><a href="https://medium.com/@weka/announcing-the-winners-of-the-first-underhanded-solidity-coding-contest-282563a87079" target="_blank" rel="noopener">The Underhanded Solidity Contest</a> [<a href="http://u.solidity.cc/" target="_blank" rel="noopener">1</a>,<a href="https://github.com/Arachnid/uscc/tree/master/submissions-2017" target="_blank" rel="noopener">2</a>,<a href="https://medium.com/@chriseth/lessons-learnt-from-the-underhanded-solidity-contest-8388960e09b1" target="_blank" rel="noopener">3</a>]</li>
<li><a href="https://github.com/trailofbits/not-so-smart-contracts/issues" target="_blank" rel="noopener">Trailofbits/not-so-smart-contracts</a></li>
<li><a href="https://eprint.iacr.org/2016/1007.pdf" target="_blank" rel="noopener">A survey of attacks on Ethereum Smart Contracts</a></li>
<li><a href="https://consensys.github.io/smart-contract-best-practices/known_attacks" target="_blank" rel="noopener">Smart contract best practices — Known attacks</a></li>
<li><a href="https://blog.zeppelin.solutions/onward-with-ethereum-smart-contract-security-97a827e47702" target="_blank" rel="noopener">Onward with Smart Contract Security</a></li>
</ul>
<p>你可以练习你的智能合约黑客技巧在：<br><a href="http://ethernaut.zeppelin.solutions/" target="_blank" rel="noopener">Ethernaut</a>（需要ropsten testnet帐户）<br><a href="http://hackthiscontract.io/" target="_blank" rel="noopener">HackThisContract</a>（需要rinkeby testnet帐户</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://zhuanlan.zhihu.com/loomnetwork" target="_blank" rel="noopener">以太坊区块链的可扩展性</a><br><a href="https://medium.com/@gakonst" target="_blank" rel="noopener">Georgios Konstantopoulos</a><br><a href="https://medium.com/loom-network/how-to-secure-your-smart-contracts-6-solidity-vulnerabilities-and-how-to-avoid-them-part-1-c33048d4d17d" target="_blank" rel="noopener">How to Secure Your Smart Contracts: 6 Solidity Vulnerabilities and how to avoid them (Part 1)</a><br><a href="https://medium.com/loom-network/how-to-secure-your-smart-contracts-6-solidity-vulnerabilities-and-how-to-avoid-them-part-2-730db0aa4834" target="_blank" rel="noopener">How to Secure Your Smart Contracts: 6 Solidity Vulnerabilities and how to avoid them (Part 2)</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/solidity/" rel="tag"># solidity</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/29/blockchain/BIP-141-隔离见证/" rel="next" title="BIP-141 隔离见证">
                <i class="fa fa-chevron-left"></i> BIP-141 隔离见证
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/03/blockchain/solidity数据类型说明/" rel="prev" title="solidity数据类型说明">
                solidity数据类型说明 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/user-avatar"
                alt="Gavin Zhang" />
            
              <p class="site-author-name" itemprop="name">Gavin Zhang</p>
              <p class="site-description motion-element" itemprop="description">一个孤独的开发者，正在互联网公司踩坑<br />邮箱：zlcgavin@gmail.com</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">96</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">92</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#范围溢出的问题"><span class="nav-number">1.</span> <span class="nav-text">范围溢出的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可视性-Visibility-和Delegatecall"><span class="nav-number">2.</span> <span class="nav-text">可视性(Visibility)和Delegatecall</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Delegatecall"><span class="nav-number">2.1.</span> <span class="nav-text">Delegatecall</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#可重入性（The-DAO黑客事件）"><span class="nav-number">3.</span> <span class="nav-text">可重入性（The DAO黑客事件）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#强行将以太币置入合约"><span class="nav-number">4.</span> <span class="nav-text">强行将以太币置入合约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调用未知（DoS意外还原）"><span class="nav-number">5.</span> <span class="nav-text">调用未知（DoS意外还原）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#短地址攻击"><span class="nav-number">6.</span> <span class="nav-text">短地址攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#漏洞"><span class="nav-number">6.1.</span> <span class="nav-text">漏洞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#额外红利"><span class="nav-number">7.</span> <span class="nav-text">额外红利</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Q-amp-A"><span class="nav-number">8.</span> <span class="nav-text">Q&amp;A</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#我能做些什么来保护我的智能合约呢"><span class="nav-number">8.1.</span> <span class="nav-text">我能做些什么来保护我的智能合约呢</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#我能用什么工具来审计和分析我的代码呢？"><span class="nav-number">8.2.</span> <span class="nav-text">我能用什么工具来审计和分析我的代码呢？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">9.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gavin Zhang</span>

  

  
</div>




  <div class="powered-by">由 Gavin 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.0.4</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.4"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
